#!/bin/bash

helpmsg() {
    echo -e 'usage: ./rr [input] [label] (-1) ($@)'
    echo -e 'usage: ./rr [input] [label] [0] [cmin cmax] ($@)'
    echo -e 'usage: ./rr [input] [label] [interval] ($@)\n'
    echo -e '   -b, --bpix        evaluate bpix tracklets only'
    echo -e '   -f, --file        output commands'
    echo -e '   -g, --group       semaphore group id'
    echo -e '   -h, --help        show (this) help message'
    echo -e '   -i, --incl        apply inclusive corrections'
    echo -e '   -j, --jobs        jobs relative to number of cores'
    echo -e '   -n, --nice        nice\n'
}

ARGS=()

while [ $# -gt 0 ]; do
    case "$1" in
        -b|--bpix)      BPIX=1; shift ;;
        -f)             FILE="$2"; shift 2 ;;
        --file=*)       FILE="${1#*=}"; shift ;;
        -g)             GROUP="$2"; shift 2 ;;
        --group=*)      GROUP="${1#*=}"; shift ;;
        -h|--help)      helpmsg; exit ;;
        -i|--incl)      INCL=1; shift ;;
        -j)             JOBS="$2"; shift 2 ;;
        --jobs=*)       JOBS="${1#*=}"; shift ;;
        -n)             NICE="$2"; shift 2 ;;
        --nice=*)       NICE="${1#*=}"; shift ;;
        -*|--*)         [[ $1 =~ ^-?[0-9]+$ ]] && \
                            { ARGS+=("$1"); shift; } || \
                            { echo -e "invalid option: $1\n"; exit 1; } ;;
        *)              ARGS+=("$1"); shift ;;
    esac
done

set -- "${ARGS[@]}"

[[ $# -lt 3 ]] && { helpmsg; exit 1; }

FLAGS="--linebuffer"
GROUP=${GROUP:-"def"}
JOBS=${JOBS:-"+0"}
NICE=${NICE:-10}

BTYPES=(12 13 14 23 24 34); FTYPES=(15 16 17)
TYPES=( "${BTYPES[@]}" )
[ -n "$BPIX" ] || TYPES+=( "${FTYPES[@]}" )

EXEC=eval
[ -n "$FILE" ] && { EXEC=echo; exec &>> $FILE; }

$EXEC 'make reap_results merge_monads collect_cents || exit 1';

if [[ $3 -gt 0 ]]; then
    for (( CMAX=20; CMAX>=$3; CMAX-=$3 )); do
        CMIN=$(( CMAX - $3 ))

        [ -n "$INCL" ] || CTAG=.a.$CMIN.$CMAX
        for TYPE in ${TYPES[@]}; do
            CMD='nice -n $NICE sem -j$JOBS --id sem-grp-rr-$GROUP $FLAGS \
                    "./reap_results $TYPE $1 $2.a.$CMIN.$CMAX \
                    $CMIN $CMAX $4$CTAG $5 ${@:6} \
                    > notes/log-rr-$2.a.$CMIN.$CMAX-$TYPE.log"'
            $EXEC `eval echo $CMD`
        done
    done
    $EXEC sem --id sem-grp-rr-$GROUP --wait

    for (( CMAX=20; CMAX>=$3; CMAX-=$3 )); do
        CMIN=$(( CMAX - $3 ))

        $EXEC ./merge_monads $2.a.$CMIN.$CMAX
    done

    $EXEC ./collect_cents $2.a $3
elif [[ $3 -eq 0 ]]; then
    [[ $# -lt 5 ]] && exit 2

    [ -n "$INCL" ] || CTAG=.s.$4.$5
    for TYPE in ${TYPES[@]}; do
        CMD='nice -n $NICE sem -j$JOBS --id sem-grp-rr-$GROUP $FLAGS \
                "./reap_results $TYPE $1 $2.s.$4.$5 \
                $4 $5 $6$CTAG $7 ${@:8} \
                > notes/log-rr-$2.s.$4.$5-$TYPE.log"'
        $EXEC `eval echo $CMD`
    done
    $EXEC sem --id sem-grp-rr-$GROUP --wait

    $EXEC ./merge_monads $2.s.$4.$5
else
    for TYPE in ${TYPES[@]}; do
        CMD='nice -n $NICE sem -j$JOBS --id sem-grp-rr-$GROUP $FLAGS \
                "./reap_results $TYPE ${@:1:2} 0 20 ${@:4} \
                > notes/log-rr-$2-$TYPE.log"'
        $EXEC `eval echo $CMD`
    done
    $EXEC sem --id sem-grp-rr-$GROUP --wait

    $EXEC ./merge_monads $2
fi

[ -n "$FILE" ] && {
    sort $FILE -u -o $FILE.tmp;
    grep make $FILE.tmp > $FILE;
    grep reap_results $FILE.tmp | grep -v make >> $FILE;
    grep -- '--wait' $FILE.tmp >> $FILE;
    grep merge_monads $FILE.tmp | grep -v make >> $FILE;
    rm $FILE.tmp
}
